<!DOCTYPE html>
<html style="height: 100%">
<head>
    <meta charset="utf-8">
    <title>Document Knowledge Network</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body style="height: 100%; margin: 0">
    <div id="container" style="height: 100%"></div>
    <script type="text/javascript">
        var dom = document.getElementById("container");
        var myChart = echarts.init(dom);
        
        // Get backend URL from current host
        // If accessed via ngrok or same domain, use current origin
        // Otherwise, use localhost:8000
        var backendUrl;
        if (window.location.hostname.includes('ngrok') || window.location.hostname.includes('ngrok-free') || window.location.hostname.includes('ngrok.io')) {
            // Accessing via ngrok - use same origin
            backendUrl = window.location.origin;
        } else {
            // Local access - use port 8000
            var host = window.location.host;
            backendUrl = window.location.protocol + "//" + host.split(':')[0] + ':8000';
        }
        
        console.log('Backend URL:', backendUrl);
        console.log('Fetching graph data from:', backendUrl + '/api/graph');
        
        // Show loading indicator
        myChart.showLoading();
        
        // Call the FastAPI /api/graph endpoint
        $.get(backendUrl + '/api/graph', function (graph) {
            console.log('Graph data received:', graph);
            console.log('Nodes:', graph.nodes ? graph.nodes.length : 0);
            console.log('Links:', graph.links ? graph.links.length : 0);
            console.log('Categories:', graph.categories ? graph.categories.length : 0);
            
            if (!graph.nodes || graph.nodes.length === 0) {
                dom.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; font-family: Arial; color: #666;"><p>No documents found. Please process some documents first.</p></div>';
                return;
            }
            myChart.hideLoading();
            
            var option = {
                title: {
                    text: 'Document Knowledge Network',
                    subtext: 'Solid Line: Keyword Match | Dashed Line: Semantic Similarity',
                    top: 'bottom',
                    left: 'right'
                },
                tooltip: {},
                legend: [{
                    // Authors as legend
                    data: graph.categories.map(function (a) { return a.name; })
                }],
                series: [
                    {
                        type: 'graph',
                        layout: 'force', // Force-directed layout, automatically disperses nodes
                        data: graph.nodes,
                        links: graph.links,
                        categories: graph.categories,
                        roam: true, // Allow zoom and pan
                        label: {
                            show: true,
                            position: 'right',
                            formatter: '{b}'
                        },
                        labelLayout: {
                            hideOverlap: true
                        },
                        scaleLimit: {
                            min: 0.4,
                            max: 2
                        },
                        lineStyle: {
                            color: 'source',
                            curveness: 0.3
                        },
                        force: {
                            repulsion: 500, // Repulsion force between nodes
                            edgeLength: [50, 200] // Edge length range
                        }
                    }
                ]
            };
            myChart.setOption(option);
        }).fail(function(xhr, status, error) {
            console.error('Error loading graph data:', error);
            console.error('Status:', status);
            console.error('Response:', xhr.responseText);
            myChart.hideLoading();
            var errorMsg = 'Error loading graph data. ';
            if (xhr.status === 0) {
                errorMsg += 'Cannot connect to backend. Please ensure the backend is running.';
            } else if (xhr.status === 500) {
                errorMsg += 'Server error: ' + (xhr.responseJSON ? xhr.responseJSON.detail : xhr.responseText);
            } else {
                errorMsg += 'HTTP ' + xhr.status + ': ' + (xhr.responseText || error);
            }
            dom.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; font-family: Arial; color: #c62828; padding: 2em;"><div style="text-align: center;"><p style="font-size: 1.2em; margin-bottom: 1em;">' + errorMsg + '</p><p style="color: #666; font-size: 0.9em;">Check browser console for details.</p></div></div>';
        });
    </script>
</body>
</html>
